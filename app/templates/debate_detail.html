{% extends "base.html" %}

{% block title %}{{ debate.title }} - 懂事論壇{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- 辯論標題區域 -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 animate-slide-in">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <!-- 狀態徽章 -->
                        {% if debate.status == 'waiting' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock mr-2"></i>等待對手
                            </span>
                        {% elif debate.status == 'ongoing' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <i class="fas fa-fire mr-2"></i>進行中
                            </span>
                        {% elif debate.status == 'judging' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-gavel mr-2"></i>評審中
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-check mr-2"></i>已完成
                            </span>
                        {% endif %}
                        
                        <!-- 分類標籤 -->
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            <i class="fas fa-tag mr-2"></i>{{ debate.category }}
                        </span>
                        
                        <!-- 緊急標籤 -->
                        {% if debate.is_urgent %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 animate-pulse-gentle">
                                <i class="fas fa-exclamation mr-2"></i>緊急
                            </span>
                        {% endif %}
                    </div>
                    
                    <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">{{ debate.title }}</h1>
                    
                    {% if debate.description %}
                        <p class="text-gray-600 text-lg leading-relaxed">{{ debate.description }}</p>
                    {% endif %}
                </div>
                
                <!-- 統計信息 -->
                <div class="mt-6 lg:mt-0 lg:ml-8">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600">{{ debate.views or 0 }}</div>
                            <div class="text-sm text-gray-600">觀看</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600">{{ debate.arguments.count() }}</div>
                            <div class="text-sm text-gray-600">論述</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600">{{ debate.followers_rel|length }}</div>
                            <div class="text-sm text-gray-600">關注</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 辯論信息 -->
            <div class="flex flex-wrap items-center gap-6 text-sm text-gray-500 border-t pt-6">
                <div class="flex items-center">
                    <i class="fas fa-user mr-2"></i>
                    發起人：{{ debate.creator.username }}
                </div>
                <div class="flex items-center">
                    <i class="fas fa-calendar mr-2"></i>
                    {{ debate.created_at.strftime('%Y年%m月%d日 %H:%M') }}
                </div>
                {% if debate.status == 'ongoing' and debate.time_remaining %}
                    <div class="flex items-center text-orange-600">
                        <i class="fas fa-hourglass-half mr-2"></i>
                        剩餘時間：{{ debate.time_remaining }}
                    </div>
                {% endif %}
                <div class="flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    每輪時限：{{ debate.time_limit_hours }}小時
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左側：辯論參與者 -->
            <div class="lg:col-span-1">
                <div class="space-y-6">
                    <!-- 正方參與者 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-green-600 flex items-center">
                                <i class="fas fa-thumbs-up mr-2"></i>
                                正方（支持）
                            </h3>
                            {% if debate.status == 'ongoing' and debate.current_turn == 'pro' %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    輪到發言
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if debate.pro_participant %}
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    {{ debate.pro_participant.username[0] }}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">{{ debate.pro_participant.username }}</div>
                                    <div class="text-sm text-gray-500">
                                        {% if debate.pro_participant.stats %}
                                            Lv.{{ debate.pro_participant.stats.level }} | 評分 {{ debate.pro_participant.stats.rating }}
                                        {% else %}
                                            新手辯手
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-user-plus text-3xl mb-2"></i>
                                <p>等待參與者加入</p>
                                {% if debate.status == 'waiting' and session.get('user_id') and session.get('user_id') != debate.creator_id %}
                                    <button onclick="joinDebate({ debateId:debate.id }, 'pro')" 
                                            class="mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg btn-animated">
                                        <i class="fas fa-plus mr-1"></i>加入正方
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 反方參與者 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-red-600 flex items-center">
                                <i class="fas fa-thumbs-down mr-2"></i>
                                反方（反對）
                            </h3>
                            {% if debate.status == 'ongoing' and debate.current_turn == 'con' %}
                                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                    輪到發言
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if debate.con_participant %}
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    {{ debate.con_participant.username[0] }}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">{{ debate.con_participant.username }}</div>
                                    <div class="text-sm text-gray-500">
                                        {% if debate.con_participant.stats %}
                                            Lv.{{ debate.con_participant.stats.level }} | 評分 {{ debate.con_participant.stats.rating }}
                                        {% else %}
                                            新手辯手
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-user-plus text-3xl mb-2"></i>
                                <p>等待參與者加入</p>
                                {% if debate.status == 'waiting' and session.get('user_id') and session.get('user_id') != debate.creator_id %}
                                    <button onclick="joinDebate({ debateId:debate.id }, 'con')" 
                                            class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg btn-animated">
                                        <i class="fas fa-plus mr-1"></i>加入反方
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 辯論規則 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-book mr-2 text-blue-500"></i>
                            辯論規則
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-600">
                            <li class="flex items-center">
                                <i class="fas fa-{{ 'check' if debate.need_sources else 'times' }} mr-2 text-{{ 'green' if debate.need_sources else 'red' }}-500"></i>
                                {{ '需要' if debate.need_sources else '不需要' }}提供資料來源
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-{{ 'check' if debate.allow_audience else 'times' }} mr-2 text-{{ 'green' if debate.allow_audience else 'red' }}-500"></i>
                                {{ '允許' if debate.allow_audience else '禁止' }}觀眾評論
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-clock mr-2 text-blue-500"></i>
                                每輪發言時限：{{ debate.time_limit_hours }}小時
                            </li>
                            {% if debate.level_limit %}
                                <li class="flex items-center">
                                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                                    等級限制：{{ debate.level_limit }}
                                </li>
                            {% endif %}
                        </ul>
                    </div>

                    <!-- 關注按鈕 -->
                    {% if session.get('user_id') %}
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <button onclick="toggleFollow({ debateId:debate.id })" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg btn-animated">
                                <i class="fas fa-heart mr-2"></i>關注此辯論
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 右側：辯論內容 -->
            <div class="lg:col-span-2">
                <!-- 當前狀態提示 -->
                {% if debate.status == 'waiting' %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-yellow-500 text-2xl mr-3"></i>
                            <div>
                                <h3 class="font-semibold text-yellow-800">等待對手加入</h3>
                                <p class="text-yellow-700">此辯論正在等待{{ '反方' if debate.pro_participant else '正方' }}參與者加入</p>
                            </div>
                        </div>
                    </div>
                {% elif debate.status == 'ongoing' %}
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-fire text-green-500 text-2xl mr-3"></i>
                                <div>
                                    <h3 class="font-semibold text-green-800">辯論進行中</h3>
                                    <p class="text-green-700">第{{ debate.current_round }}輪 - 輪到{{ '正方' if debate.current_turn == 'pro' else '反方' }}發言</p>
                                </div>
                            </div>
                            {% if debate.time_remaining %}
                                <div class="text-right">
                                    <div class="text-lg font-bold text-green-800">{{ debate.time_remaining }}</div>
                                    <div class="text-sm text-green-600">剩餘時間</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                <!-- 論述區域 -->
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="border-b border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-comments mr-2 text-blue-500"></i>
                            辯論論述
                        </h3>
                    </div>
                    
                    <div class="p-6">
                        {% if arguments %}
  <div class="space-y-6">
    {% for argument in arguments %}
      ...
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-12 text-gray-500">
    <i class="fas fa-comments text-4xl mb-4"></i>
    <h3 class="text-lg font-semibold mb-2">尚未有論述</h3>
    <p>成為第一個發表論述的人吧！</p>
  </div>
{% endif %}
                        {% if arguments %}
                            <div class="space-y-6">
                                {% for argument in arguments %}
                                    <div class="border-l-4 {% if argument.position == 'pro' %}border-green-500 bg-green-50{% else %}border-red-500 bg-red-50{% endif %} p-4 rounded-r-lg">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-10 h-10 {% if argument.position == 'pro' %}bg-green-500{% else %}bg-red-500{% endif %} rounded-full flex items-center justify-center text-white font-bold">
                                                    {{ argument.user.username[0] }}
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-900">
                                                        {{ argument.user.username }}
                                                        <span class="ml-2 px-2 py-1 text-xs rounded-full {% if argument.position == 'pro' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                            {{ '正方' if argument.position == 'pro' else '反方' }}
                                                        </span>
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        第{{ argument.round_number }}輪 • {{ argument.created_at.strftime('%m月%d日 %H:%M') }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="prose max-w-none">
                                            <p class="text-gray-800 leading-relaxed">{{ argument.content }}</p>
                                        </div>
                                        
                                        {% if argument.sources %}
                                            <div class="mt-4 pt-4 border-t {% if argument.position == 'pro' %}border-green-200{% else %}border-red-200{% endif %}">
                                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                                    <i class="fas fa-link mr-2"></i>資料來源
                                                </h4>
                                                <div class="text-sm text-gray-600">
                                                    {{ argument.sources }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-comments text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold mb-2">尚未有論述</h3>
                                <p>成為第一個發表論述的人吧！</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- 發言區域 -->
                    {% if debate.status == 'ongoing' and session.get('user_id') %}
                        {% set can_speak = (debate.current_turn == 'pro' and debate.pro_participant_id == session.get('user_id')) or (debate.current_turn == 'con' and debate.con_participant_id == session.get('user_id')) %}
                        {% if can_speak %}
                            <div class="border-t border-gray-200 p-6 bg-blue-50">
                                <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-microphone mr-2 text-blue-500"></i>
                                    輪到您發言了！
                                </h4>
                                
                                <form method="POST" action="{{ url_for('main.add_argument') }}" class="space-y-4">
                                    <input type="hidden" name="debate_id" value="{{ debate.id }}">
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">您的論述</label>
                                        <textarea name="content" rows="6" required 
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                                  placeholder="請輸入您的論述內容..."></textarea>
                                    </div>
                                    
                                    {% if debate.need_sources %}
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                資料來源 <span class="text-red-500">*</span>
                                            </label>
                                            <textarea name="sources" rows="2" required 
                                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                                      placeholder="請提供可信的資料來源連結或引用..."></textarea>
                                        </div>
                                    {% else %}
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">資料來源（選填）</label>
                                            <textarea name="sources" rows="2" 
                                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                                      placeholder="可提供資料來源以增強論述可信度..."></textarea>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-500">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            請確保您的論述客觀、理性且有理有據
                                        </div>
                                        <button type="submit" 
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg btn-animated">
                                            <i class="fas fa-paper-plane mr-1"></i>發表論述
                                        </button>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- 觀眾評論區 -->
                {% if debate.allow_audience %}
                    <div class="bg-white rounded-xl shadow-lg mt-6">
                        <div class="border-b border-gray-200 p-6">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-users mr-2 text-purple-500"></i>
                                觀眾評論
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            {% if session.get('user_id') %}
                                <div class="mb-6">
                                    <form method="POST" action="{{ url_for('main.add_comment') }}" class="space-y-4">
                                        <input type="hidden" name="debate_id" value="{{ debate.id }}">
                                        <div>
                                            <textarea name="content" rows="3" required 
                                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                                      placeholder="分享您對此辯論的看法..."></textarea>
                                        </div>
                                        <div class="flex justify-end">
                                            <button type="submit" 
                                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg btn-animated">
                                                <i class="fas fa-comment mr-1"></i>發表評論
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            {% endif %}
                            
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-comment text-3xl mb-2"></i>
                                <p>觀眾評論功能開發中...</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 分享對話框 -->
<div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-bold mb-4">分享此辯論</h3>
        <div class="space-y-3">
            <button onclick="shareToFacebook()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center justify-center">
                <i class="fab fa-facebook mr-2"></i>分享到 Facebook
            </button>
            <button onclick="shareToTwitter()" class="w-full bg-blue-400 hover:bg-blue-500 text-white p-3 rounded-lg flex items-center justify-center">
                <i class="fab fa-twitter mr-2"></i>分享到 Twitter
            </button>
            <button onclick="copyLink()" class="w-full bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg flex items-center justify-center">
                <i class="fas fa-link mr-2"></i>複製連結
            </button>
        </div>
        <button onclick="closeShareModal()" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 p-2 rounded-lg">
            取消
        </button>
    </div>
</div>

<script>
// 加入辯論
function joinDebate(debateId, position) {
    if (!confirm(`確定要以${position === 'pro' ? '正方' : '反方'}身份加入這場辯論嗎？`)) {
        return;
    }
    
    fetch('{{ url_for("main.join_debate") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            debate_id: debateId,
            position: position
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('加入失敗：' + data.message);
        }
    })
    .catch(error => {
        alert('操作失敗，請稍後再試');
    });
}

// 關注/取消關注辯論
function toggleFollow(debateId) {
    fetch('{{ url_for("main.toggle_follow") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            debate_id: debateId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('操作失敗：' + data.message);
        }
    })
    .catch(error => {
        alert('操作失敗，請稍後再試');
    });
}

// 分享功能
function openShareModal() {
    document.getElementById('shareModal').classList.remove('hidden');
    document.getElementById('shareModal').classList.add('flex');
}

function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
    document.getElementById('shareModal').classList.remove('flex');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ debate.title }}');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank', 'width=600,height=400');
}

function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('{{ debate.title }} - 懂事論壇');
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        alert('連結已複製到剪貼板');
        closeShareModal();
    });
}

// 自動刷新辯論狀態
setInterval(function() {
    if ('{{ debate.status }}' === 'ongoing') {
        location.reload();
    }
}, 60000); // 每分鐘刷新一次
</script>
{% endblock %}